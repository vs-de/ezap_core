#!/usr/bin/env ruby
require 'ezap_core'

  #//TODO: ezap (g)enerate <service> <name>
  #//TODO: ezap (g)enerate <web_app> <controller|view> <name>
  #//TODO: ezap (i)nstall [args]

#class SrvAdp < Ezap::ServiceAdapter
#  def stop ; service_request :stop ; end
#end

module EzapExec
  
  module CM
    
    def start(*args, type: nil, name: nil)
      puts args.inspect
      unless name #should be same as type || name
        if args.first == 'fg'
          Ezap::Service::GlobalMaster.start(daemonize: false)
        else
          Ezap::Service::GlobalMaster.start
        end
      else
        puts "name not implemented"
      end
    end

    def start_service name
        puts "starting #{args} - no implemented"
    end

    def stop_service name
      hsh = Ezap::Service::GlobalMaster.locate_service name
      addr = hsh['address']
      return (puts "service '#{name}' not found") unless addr
      sock = Ezap::Sock.new(:req)
      sock.connect addr
      sock.send_obj [:stop]
      asw = sock.recv_obj
      $stderr.puts "error: asw not ack: #{asw}" unless asw == 'ack'
      sock.close
      sleep 0.1
      #check presence again
      hsh = Ezap::Service::GlobalMaster.locate_service name
      addr = hsh['address']
      if addr
        return $stderr.puts "error: service still up!"
      else
        puts "service stopped."
      end
    end

    def run_expression *args
      eval args.join(" ")
    end

    def stop name=nil
      unless name
        Ezap::Service::GlobalMaster.shutdown
      else
        stop_service name
      end
    end

    def gm_ping *args
      if args.size > 0
        args = [args.first.to_f]
      end
      puts [Ezap::Service::GlobalMaster.ping(*args)].flatten.first
    end

    def help *args
      puts help_msg
    end

    def run_console *args
      
      require 'irb'
      #exec 'irb -r $EZAP_ROOT/lib/console_defs.rb'
      require 'console_defs'
      ARGV.clear
      IRB.start
      puts "goodbye"
    end

    def help_msg
<<HELP

  << -- e z a p -- >>

usage:
  ezap (s)tart [<service|web_app>] name]
  ezap stop/(h)alt [service]
  ezap (r)un <file/args to 'ruby'>
  ezap (e)val <ruby-expression>
  ezap (c)onsole
  ezap gm_ping(/gmp)
  ezap help

HELP
    end


  end

  extend CM
end

EE = EzapExec
args = ARGV.clone
case args.shift
  when 's', 'start'
    EE.start *args
  when 'h',' halt', 'stop'
    EE.stop *args
  when 'c', 'console'
    EE.run_console *args
  when 'e', 'eval'
    EE.run_expression *args
  when 'help'
    EE.help *args
  when 'gmp', 'gm_ping'
    EE.gm_ping *args
  else
    $stderr.puts "unrecognized args"
    EE.help *args
end
